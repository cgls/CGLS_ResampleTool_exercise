---
title: "NDVI Resampling using R-based tools"
subtitle: ""
author:
  - Xavier Rotllan-Puig:
      email: xavier.rotllan.puig@aster-projects.cat
      institute: [jrc, aster]
      correspondence: true
  - Federico Gianoli:
      institute: [jrc]
  - Pier Lorenzo Marasco:
      institute: [jrc]
  - Michael Cherlet:
      institute: [jrc]
 
institute:
  - jrc: Joint Research Centre – European Commission. Directorate D – Sustainable Resources. Unit D6 – Knowledge for Sustainable Development & Food Security Unit. Via Enrico Fermi 2749. I-21027 Ispra (VA), ITALY
  - aster: ASTER-Projects. Barri Reboll, 9, 1r. 08694 Guardiola de Berguedà (Barcelona), SPAIN

date: "`r format(Sys.time(), '%d/%m/%Y')`"

output: 
  word_document:
    reference_docx: /Users/xavi_rp/Documents/D6_LPD/LPD/ATBD/LPD_MS_styles.docx
    #toc: true #table of content true
    toc_depth: 3  #up to three depths of headings (specified by #, ## and ###)
    #number_sections: true  #number sections at each table header
    #theme: united  #options for theme
    #highlight: tango  #syntax highlighting style
    #css: style.css   #custom css, should be in same folder. Only for HTML
    pandoc_args:
      - --lua-filter=scholar-metadata.lua
      - --lua-filter=author-info-blocks.lua
      
#bibliography: lpd_biblio.bib
#csl: methods-in-ecology-and-evolution.csl
always_allow_html: yes
---

```{r setup, include = FALSE, results='asis'}
library(knitr)
library(pander)
library(captioner)
library(raster)
knitr::opts_chunk$set(echo = TRUE)

```

```{r include = FALSE}
if(Sys.info()[4] == "D01RI1700371"){
  path2data <- "E:/rotllxa/NDVI_resample/NDVI_data"
  path2save <- "E:/rotllxa/NDVI_resample/NDVI_resample_Europe"
}else if(Sys.info()[4] == "h05-wad.ies.jrc.it"){
  path2data <- ""
  path2save <- ""
}else if(Sys.info()[4] == "MacBook-MacBook-Pro-de-Xavier.local"){
  path2data <- "/Users/xavi_rp/Documents/D6_LPD/NDVI_data"
  path2save <- "/Users/xavi_rp/Documents/D6_LPD/NDVI_resample/NDVI_resample_Europe"
}else{
  stop("Define your machine before to run LPD")
}

load(file = paste0(path2save, "/ResampleResults_NDVI_europe_4Report.RData"), verbose = FALSE)


table_num <- captioner::captioner(prefix = "Table")
fig_num <- captioner::captioner(prefix = "Figure")
#ts <- 0
```


**Abstract**



# Introduction

The Copernicus Global Land Service (CGLS; https://land.copernicus.eu/global/) is a component of the Land Monitoring Core Service (LMCS) of Copernicus, the European flagship programme on Earth Observation. CGLS systematically produces and distributes time series of global bio-geophysical products on the status and evolution of the land surface, at different spatial resolutions. These products are used to monitor the vegetation, the water cycle, the energy budget and the terrestrial cryosphere. 

The CGLS vegetation-related products (i.e. NDVI, FAPAR...), based on PROBA-V observations, have been distributed at 1km and 333m until June, 2020. As of this date, the new products are no longer provided at 1km resolution. However, the users who might be interested on continuing their 1km time series can use a resample of the 333 m products.

The Joint Research Centre (European Commission) provides different tools to help the users make their own resampling exercices. For example, a Notebook with R code and some explanations can be found at https://nbviewer.jupyter.org/github/VITObelgium/notebook-samples/blob/master/datasets/probav/ResampleTool_R_notebook.ipynb. In addition, Python code to run in QGIS can be found in ...**Fede??**.

In this document we present some comparisons of the results obtained with these two resampling tools with the original CGLS products at 1km resolution, as well as among them. 



# Materials and methods

## Data sets

```{r include = FALSE}
work_extent <- round(as.vector(my_extent), 2)
work_extent <- paste(c("xmin = ", "xmax = ", "ymin = ", "ymax = "), work_extent)

Sys.setlocale("LC_TIME", "C")
img_date <- format(as.Date(img_date), "%B %d, %Y")

fig1_300m <- fig_num(name = "f1_300", caption = "NDVI working map at 333m resolution")
orig_300map <- paste0(path2save, "/ndvi_300m_orig_Eur.jpg")

#fig2_1km <- fig_num(name = "f2_1km", caption = "NDVI working map at 1km resolution used to evaluate the rersampled map")
#orig_1map <- paste0(path2save, "/ndvi_1km_orig_Eur.jpg")

```

The analysis has been done using a subset of the 10-daily Normalized Difference Vegetation Index (NDVI) global product. The selected images (i.e. 1km and 33m resolution) were taken the `r img_date`, and the working maps were cut between the coordinates (DD) `r work_extent`. `r fig_num("f1_300", display = "cite")` shows the 333m NDVI working map used for the resampling.

![`r fig1_300m`](`r orig_300map`)



The original Global Land product files usually can be downloaded as a netCDF4 file. They can often contain specific values for invalid pixels (flagged values), which need to be dealt with. In the case of the NDVI products, digital values in the netCDF (DN) > 250 are flagged and need to be converted into NA. When the netCDF files are read in as a *raster* object, the digital values are scaled into real NDVI values automatically. After that, all pixels with NDVI values > 0.92 (= DN 250 x scale + offset) were set to NA.

The information regarding flagged values, as well as other supporting information, can be seen in the netCDF file metadata. In addition, more details on the CGLS global products can be found in their Product User Manual documentation at https://land.copernicus.eu/global/products/. 



## Resample method

There are several approaches to resample data from a finer to a coarser resolution. They could be grouped into area-based aggregation methods and point-based interpolation methods (e.g. Bilinear and Nearest Neighbour), and can be applied depending on the data type, etc.

The aggregation method used in this assessment groups rectangular matrix of pixels of the finer resolution image to create a new map with larger cells. In this case, as we wanted to resample from 333m to 1km, a factor of 3 was implemented (i.e. a matrix of 3x3 pixels).

On the one hand, for the R-based (R Core Team, 2019) method, the function *aggregate()* of the package *raster* (Hijmans, 2019) was used. *aggregate()* can perform the calculation using different functions. While the default is the average (*mean()*) it can work also with *modal()*, *max()*, *min()* or even with *ad hoc* functions programmed by the user. For NDVI products the most suitable method is the average, but we also included the condition that at least 5 out of the 9 pixels had to have valid values (i.e. not NA).

On the other hand, for the Python-based (Van Rossum, G. & Drake, F.L., 2009) method implemented for QGIS (QGIS Development Team, 2009).... **Fede**


## Metrics and plots

In order to assess the performance of the resampling methods, besides maps of the results, three well known and widely used metrics and a scatterplot were produced. The metrics are:

* Pearson correlation coefficient (Pearson's *r*)

* Root-mean-square error (RMSE)

* Mean absolute error (MAE) 


The R code used to perform the assessment reported in this document can be seen at https://github.com/xavi-rp/NDVI_resample. 



# Results

```{r include = FALSE}
comp_results[, 2:4] <- round(comp_results[, 2:4], 3)
comp_results_df <- table_num(name = "comp_results_table", caption = "")

fig_1km_1km_Raggr <- fig_num(name = "f_1km_1km_Raggr", caption = "Original NDVI map at 1km resolution and the resampled one using the R-based method")
orig_Raggr <- paste0(path2save, "/ndvi1km_1kmResampled_RAggr.jpg")

fig_1km_1km_Raggr_scat <- fig_num(name = "f_1km_1km_Raggr_scat", caption = "Scatter plot displaying a random subset (1%) of pixel values of the 1km original NDVI product against the values of the same pixels of the resampled map using the R method (blue points). Also the regression (red) line")
orig_Raggr_scat <- paste0(path2save, "/resample_correlation_RAggr.jpg")



```

`r table_num("comp_results_table", display = "cite")` shows the three metrics calculated to evaluate the comparisons of the two resampling methods among them and with the original CGLS NDVI product at 1 km resolution.

`r table_num("comp_results_table", display = "full")`
```{r echo = FALSE}
pander(comp_results)
```
&nbsp;


## R-based method vs Python-based method




## R-based method vs original 1km product

`r fig_num("f_1km_1km_Raggr", display = "cite")` shows both the original NDVI map at 1km resolution and the resampled one to 1km using the R-based method. 

![`r fig_1km_1km_Raggr`](`r orig_Raggr`)

As it can be seen in the scatterplot (`r fig_num("f_1km_1km_Raggr_scat", display = "cite")`), and corroborated by the Pearson's *r* (`r comp_results[1, 2]`), there was a good level of correlation among the original 1km map and the resampled one using the R method. Also RMSE and MAE reported good levels of 'error' among the two maps (`r paste0(comp_results[1, 3], " and ", comp_results[1, 4], ", respectively")`). 


![`r fig_1km_1km_Raggr_scat`](`r orig_Raggr_scat`)







## Python-based method vs original 1km product



# Conclusions

In this document we show...

differences in the temporal composition of the 300m and 1km products

Both methods assessed (i.e. R-based and Python-based) perform equally well. Therefore, both can be used indistinctly, depending only on the user's preferences. 


# References

Hijmans, R.J. 2019. raster: Geographic Data Analysis and Modeling. R package version 3.0-2. https://CRAN.R-project.org/package=raster

QGIS Development Team. 2009. QGIS Geographic Information System. Open Source Geospatial Foundation. URL http://qgis.org

R Core Team. 2019. R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.

Van Rossum, G. & Drake, F.L. 2009. Python 3 Reference Manual, Scotts Valley, CA: CreateSpace.


