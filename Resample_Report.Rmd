---
title: "NDVI Resampling using R-based tools"
subtitle: ""
author:
  - Xavier Rotllan-Puig:
      email: xavier.rotllan.puig@aster-projects.cat
      institute: [jrc, aster]
      correspondence: true
  - Tim Jacobs:
      institute: [vito]
  - Federico Gianoli:
      institute: [jrc]
  - Pier Lorenzo Marasco:
      institute: [jrc]
  - Michael Cherlet:
      institute: [jrc]
 
institute:
  - jrc: Joint Research Centre – European Commission. Directorate D – Sustainable Resources. Unit D6 – Knowledge for Sustainable Development & Food Security Unit. Via Enrico Fermi 2749. I-21027 Ispra (VA), ITALY
  - aster: ASTER-Projects. Barri Reboll, 9, 1r. 08694 Guardiola de Berguedà (Barcelona), SPAIN
  - vito: VITO NV. Boeretang 200. BE-2400 Mol, BELGIUM

date: "`r format(Sys.time(), '%d/%m/%Y')`"

output: 
  word_document:
    reference_docx: /Users/xavi_rp/Documents/D6_LPD/LPD/ATBD/LPD_MS_styles.docx
    #toc: true #table of content true
    toc_depth: 3  #up to three depths of headings (specified by #, ## and ###)
    #number_sections: true  #number sections at each table header
    #theme: united  #options for theme
    #highlight: tango  #syntax highlighting style
    #css: style.css   #custom css, should be in same folder. Only for HTML
    pandoc_args:
      - --lua-filter=scholar-metadata.lua
      - --lua-filter=author-info-blocks.lua
      
#bibliography: lpd_biblio.bib
#csl: methods-in-ecology-and-evolution.csl
always_allow_html: yes
---

```{r setup, include = FALSE, results='asis'}
library(knitr)
library(pander)
library(captioner)
library(raster)
knitr::opts_chunk$set(echo = TRUE)

```

```{r include = FALSE}
if(Sys.info()[4] == "D01RI1700371"){
  path2data <- "E:/rotllxa/NDVI_resample/NDVI_data"
  path2save <- "E:/rotllxa/NDVI_resample/NDVI_resample_Europe"
}else if(Sys.info()[4] == "h05-wad.ies.jrc.it"){
  path2data <- ""
  path2save <- ""
}else if(Sys.info()[4] == "MacBook-MacBook-Pro-de-Xavier.local"){
  path2data <- "/Users/xavi_rp/Documents/D6_LPD/NDVI_data"
  path2save_LAI_Eur <- "/Users/xavi_rp/Documents/D6_LPD/NDVI_resample/LAI_resample_Europe"
  path2save_LAI_Ama <- "/Users/xavi_rp/Documents/D6_LPD/NDVI_resample/LAI_resample_amazonia"
  path2save_NDVI_Eur <- "/Users/xavi_rp/Documents/D6_LPD/NDVI_resample/NDVI_resample_Europe"
}else{
  stop("Define your machine before to run LPD")
}

load(file = paste0(path2save_NDVI_Eur, "/ResampleResults_NDVI_europe_4Report.RData"), verbose = FALSE)
comp_results_NDVI_Eur <- comp_results
my_extent_eur <- my_extent
load(file = paste0(path2save_LAI_Eur, "/ResampleResults_LAI_europe_4Report.RData"), verbose = FALSE)
comp_results_LAI_Eur <- comp_results
load(file = paste0(path2save_LAI_Ama, "/ResampleResults_LAI_amazonia_4Report.RData"), verbose = FALSE)
comp_results_LAI_Ama <- comp_results
my_extent_ama <- my_extent


table_num <- captioner::captioner(prefix = "Table")
fig_num <- captioner::captioner(prefix = "Figure")
#ts <- 0
```


**Abstract**



# Introduction

The Copernicus Global Land Service (CGLS; https://land.copernicus.eu/global/) is a component of the Land Monitoring Core Service (LMCS) of Copernicus, the European flagship programme on Earth Observation. CGLS systematically produces and distributes time series of global bio-geophysical products on the status and evolution of the land surface, at different spatial resolutions. These products are used to monitor the vegetation, the water cycle, the energy budget and the terrestrial cryosphere. 

The CGLS vegetation-related products (i.e. NDVI, LAI, FAPAR...), based on PROBA-V observations, have been distributed at 1km and 333m until June, 2020. As of July, 2020, all Near Real Time (NRT) production of the vegetation biophysical variables, based on Sentinel-3 observations, are no longer provided at 1km resolution. However, the users who might be interested on continuing their 1km time series can use a resample of the new 333m products.

The science and production teams of the Global Land service, in support to the 1km users, provide different tools to make their own resampling exercises from the new 333m products to a 1km resolution, corresponding to the usual 1km grid. A Notebook with R code and some explanations can be found at https://nbviewer.jupyter.org/github/VITObelgium/notebook-samples/blob/master/datasets/probav/ResampleTool_R_notebook.ipynb. In addition, Python code to run in QGIS can be found in ...**Fede??**.

In this document we present a comparison of different resampled products using these two tools with the original CGLS products at 1km resolution for different areas. In addition, a comparison of the results obtained with both tools is also provided.



# Materials and methods

## Data sets

```{r include = FALSE}
work_extent_eur <- round(as.vector(my_extent_eur), 2)
work_extent_eur <- paste(c("xmin = ", "xmax = ", "ymin = ", "ymax = "), work_extent_eur)

work_extent_ama <- round(as.vector(my_extent_ama), 2)
work_extent_ama <- paste(c("xmin = ", "xmax = ", "ymin = ", "ymax = "), work_extent_ama)

Sys.setlocale("LC_TIME", "C")
img_date <- format(as.Date(img_date), "%B %d, %Y")

fig_ndvi_300m_eur <- fig_num(name = "f_ndvi_300_eur", caption = "NDVI map at 333m resolution for the European-North African working extent")
orig_ndvi_300map <- paste0(path2save_NDVI_Eur, "/ndvi_300m_orig_Eur.jpg")

fig_lai_300m_ama <- fig_num(name = "f_lai_300_ama", caption = "LAI map at 333m resolution for the Amazonian working extent")
orig_lai_300map <- paste0(path2save_LAI_Ama, "/lai_300m_orig_Amaz.jpg")
```

The analysis was done using different subsets of several 10-daily CGLS vegetation-related global products (i.e. Normalized Difference Vegetation Index-NDVI and Leaf area index-LAI). The selected images (i.e. 1km and 333m resolution) were taken the `r img_date`, and the assessments were made in two different areas. On the one hand, NDVI resampled product was tested for Europe and North Africa (coordinates in Decimal Degrees `r work_extent_eur`) in order to have a wide representation of different landscapes. On the other hand, the LAI product was tested both using the same European-North African window and also on a subset from a tropical area (Amazonia; coordinates `r work_extent_ama`) in order to have as well a good representation of evergreen broadleaf forests. While `r fig_num("f_ndvi_300_eur", display = "cite")` shows the 333m NDVI working map used for the resampling in Europe-North Africa, `r fig_num("f_lai_300_ama", display = "cite")` shows the 333m LAI working map used for the Amazonian area.

![`r fig_ndvi_300m_eur`](`r orig_ndvi_300map`)


![`r fig_lai_300m_ama`](`r orig_lai_300map`)


The original Global Land product files usually can be downloaded as a netCDF4 file. They can often contain specific values for invalid pixels (flagged values), which need to be dealt with. In the case of the NDVI products, digital values in the netCDF (DN) > 250 are flagged and need to be converted into NA. When the netCDF files are read in as a *raster* object, the digital values are scaled into real NDVI values automatically. After that, all pixels with NDVI values bigger than 0.92 (= DN 250 x scale + offset) were set to NA. In the same way, LAI values bigger than 7 and smaller than 0, if any, were converted to NAs.

The information regarding flagged values, as well as other supporting information, can be seen in the netCDF file metadata. In addition, more details on the CGLS global products can be found in their Product User Manual documentation at https://land.copernicus.eu/global/products/. 



## Resample method
```{r echo = FALSE}
cutoff_method_df <- read.csv(paste0("//Users/xavi_rp/Documents/D6_LPD/ResampleTool_notebook", "/Table_cutoff_and_resampleMethod.csv"),
                             stringsAsFactors = FALSE,
                             header = TRUE)

method_df <- table_num(name = "method_table", caption = "Best suited method recommended for each product/layer.")

```


There are several approaches to resample data from a finer to a coarser resolution. They can be grouped into area-based aggregation methods and point-based interpolation methods (e.g. Bilinear and Nearest Neighbour), and can be applied depending on the data type, etc. Preliminary tests run on NDVI products, not showed in this document, gave nearly equal results for both approaches.

The aggregation method used in this assessment groups rectangular matrix of pixels of the finer resolution image to create a new map with larger cells. In this case, as we wanted to resample from 333m to 1km, a factor of 3 was implemented (i.e. a matrix of 3x3 pixels).

On the one hand, for the R-based (R Core Team, 2019) method, the function *aggregate()* of the package *raster* (Hijmans, 2019) was used. *aggregate()* can perform the calculation using different functions. While the default is the average (*mean()*) it can work also with *modal()*, *max()*, *min()* or even with *ad hoc* functions programmed by the user. For both the NDVI and the LAI products the most suitable method is the average. `r table_num("method_table", display = "cite")` shows a recommendation of the best suited method for each product/layer. In addition, as it is also recommended in the tool, it was included the condition that at least 5 out of the 9 pixels must have valid values (i.e. not NA) to return a valid value for the resampled pixel.


`r pander(cutoff_method_df[, c(1:2, 8)], caption = method_df)`
&nbsp;

On the other hand, for the Python-based (Van Rossum, G. & Drake, F.L., 2009) method implemented for QGIS (QGIS Development Team, 2009).... **Fede**
&nbsp;


## Metrics and plots

In order to assess the performance of the resampling methods, besides mapping the results, three well known and widely used metrics and a scatterplot were produced. The metrics are:

* Pearson correlation coefficient (Pearson's *r*)

* Root-mean-square error (RMSE)

* Mean absolute error (MAE) 


The R code used to perform the assessment reported in this document can be seen at https://github.com/xavi-rp/NDVI_resample. 
&nbsp;



# Results

```{r include = FALSE}
comp_results <- comp_results_NDVI_Eur
comp_results <- rbind(comp_results, comp_results_LAI_Eur, comp_results_LAI_Ama)
comp_results[, 2:4] <- round(comp_results[, 2:4], 3)
comp_results[1:5, 1] <- c("NDVI_Europe/NorthAfrica_R", "NDVI_Europe/NorthAfrica_QGIS/Python", "NDVI_Eur/NorthAf_R_vs_QGIS/Python", "LAI_Europe/NorthAfrica_R", "LAI_Amazonia_R")
names(comp_results) <-c("Assessment", "Pearson's *r*", "RMSE", "MAE")

comp_results_df <- table_num(name = "comp_results_table", caption = "Pearson's *r*, Root Mean Square Error (RMSE) and Mean Absolute Error (MAE) of each case study")



```

In this document we present five different assessments depending on the CGLS product analised, the area of study and the resampling tool in use. While three of them compare the resampling results obtained with the R-based tool (1 NDVI and 2 LAI) against the original 1km product, one analyses the QGIS/Python results (NDVI) against the same 1km product and another one compares the results of both tools (R vs QGIS/Python).

`r table_num("comp_results_table", display = "cite")` summarizes the three metrics calculated in each assessment, so that an overview of all the cases is provided. In the following subsections each case will be developed in more detail separatedly. 

`r pander(comp_results, caption = comp_results_df)`
&nbsp;



## R-based tool vs the original 1km product: NDVI - Europe/North Africa

```{r echo = FALSE}
fig_1km_1km_Raggr_NDVI_eur <- fig_num(name = "f_1km_1km_Raggr_NDVI_eur", caption = "Original NDVI map at 1km resolution and the resampled one using the R-based tool for Europe/North Africa")
orig_Raggr_NDVI_eur <- paste0(path2save_NDVI_Eur, "/ndvi1km_1kmResampled_RAggr.jpg")

fig_1km_1km_Raggr_NDVI_eur_scat <- fig_num(name = "f_1km_1km_Raggr_NDVI_eur_scat", caption = "Scatter plot displaying a random subset (1%) of pixel values of the 1km original NDVI product against the values of the same pixels of the resampled map using the R tool (blue points) for Europe/North Africa. Also the regression (red) line")
orig_Raggr_NDVI_eur_scat <- paste0(path2save_NDVI_Eur, "/resample_correlation_RAggr.jpg")

```


To have a first impression of the results of the resample tool, `r fig_num("f_1km_1km_Raggr_NDVI_eur", display = "cite")` shows both the original NDVI map at 1km resolution for the region of study (Europe and North Africa) and the resampled one to 1km using the R-based tool. 

![`r fig_1km_1km_Raggr_NDVI_eur`](`r orig_Raggr_NDVI_eur`)

As it can be seen in the scatterplot (`r fig_num("f_1km_1km_Raggr_NDVI_eur_scat", display = "cite")`), and corroborated by the Pearson's *r* (`r comp_results[1, 2]`), there was a good level of correlation among the original 1km map and the resampled one using the R tool. In addition, considering that NDVI values ranged from -0.08	to 0.92, also RMSE and MAE reported good levels of 'error' among the two maps (`r paste0(comp_results[1, 3], " and ", comp_results[1, 4], ", respectively")`). 


![`r fig_1km_1km_Raggr_NDVI_eur_scat`](`r orig_Raggr_NDVI_eur_scat`)







## QGIS/Python tool vs the original 1km product: NDVI-Europe/North Africa


## R-based tool vs QGIS/Python-based tool: NDVI-Europe/North Africa

## R-based tool vs the original 1km product: LAI - Europe/North Africa

## R-based tool vs the original 1km product: LAI - Amazonia




















# Conclusions

In this document we show...

differences in the temporal composition of the 300m and 1km products

Both methods assessed (i.e. R-based and Python-based) perform equally well. Therefore, both can be used indistinctly, depending only on the user's preferences. 


# References

Hijmans, R.J. 2019. raster: Geographic Data Analysis and Modeling. R package version 3.0-2. https://CRAN.R-project.org/package=raster

QGIS Development Team. 2009. QGIS Geographic Information System. Open Source Geospatial Foundation. URL http://qgis.org

R Core Team. 2019. R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.

Van Rossum, G. & Drake, F.L. 2009. Python 3 Reference Manual, Scotts Valley, CA: CreateSpace.


